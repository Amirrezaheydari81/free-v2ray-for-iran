# /.github/workflows/update.yml

name: Automated V2Ray Config Sync

# Ø²Ù…Ø§Ù†Ø¨Ù†Ø¯ÛŒ: Ù‡Ø± Ø¯Ùˆ Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø± (Ø¯Ù‚ÛŒÙ‚Ù‡ 0ØŒ Ù‡Ø± 2 Ø³Ø§Ø¹ØªØŒ Ù‡Ø± Ø±ÙˆØ²ØŒ Ù‡Ø± Ù…Ø§Ù‡ØŒ Ù‡Ø± Ø±ÙˆØ² Ù‡ÙØªÙ‡)
on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch: # Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Ù…Ù‡Ù…: Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨ØªÙˆØ§Ù†ÛŒÙ… ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Commit Ùˆ Push Ú©Ù†ÛŒÙ…ØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ù†Ø§Ù…Ù‡ Git Ø¯Ø§Ø±ÛŒÙ…
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…ÛŒØªâ€ŒÙ‡Ø§

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10" # Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØªÙˆÙ† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ

      - name: Install dependencies
        run: |
          # Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ†
          pip install requests beautifulsoup4

      - name: Run Configuration Update Script
        run: |
          # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø§ÛŒØªÙˆÙ†
          python scripts/update_configs.py
        id: script_run

      - name: Check for Changes and Commit
        run: |
          # Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ index.html ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±
          if git diff --exit-code index.html; then
            echo "index.html ØªØºÛŒÛŒØ±ÛŒ Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª. Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Push Ù†ÛŒØ³Øª."
          else
            echo "index.html ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª. Commit Ùˆ Push Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯."

            # 1. ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Commit
            git config --global user.name "GitHub Action Bot"
            git config --global user.email "action@github.com"

            # 2. Add Ùˆ Commit
            git add index.html
            git commit -m "ğŸ¤– Auto-Update: Updated V2Ray configurations from sources (Scheduled Run)"

            # 3. Push Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø´Ø§Ø®Ù‡ ÙØ¹Ù„ÛŒ (HEAD)
            git push
          fi
